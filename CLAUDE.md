# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 프로젝트 개요

한국 세무회계 자동화 프로그램. 사용자가 증빙(엑셀/영수증)만 업로드하면, AI가 기장부터 세금 신고 파일 생성까지 처리하는 시스템.

## 기술 스택

- **프레임워크:** Next.js (App Router, Server Actions) — 풀스택
- **언어:** TypeScript (strict mode)
- **UI:** React + Tailwind CSS + Shadcn UI
- **데이터베이스:** Supabase (PostgreSQL + Auth + Storage + Edge Functions)
- **배포:** Vercel
- **엑셀 처리:** SheetJS (xlsx) — 서버 사이드에서 은행/카드 엑셀 파싱
- **AI 연동:** Claude API (Anthropic SDK) — 분개 추론, RAG 검색
- **벡터 DB:** Supabase pgvector — 세법 PDF 지식 베이스
- **인증:** Supabase Auth (카카오 OAuth)
- **참고 프로젝트:** `C:\Data\Antigravity\parramattagolf` — Supabase 연동 패턴, 미들웨어, 서버 액션 구조 동일하게 따름

## 시스템 아키텍처 (4단계 파이프라인)

```
[1. 데이터 수집] → [2. 지능형 분개] → [3. 세무 검토] → [4. 결과물 생성]
```

### 1단계: 데이터 수집
- 입력 소스: 은행 입출금 내역, 신용카드 내역, 전자세금계산서, 급여 내역
- OCR로 종이 영수증 처리
- 다양한 은행/카드사 엑셀 양식을 통합 데이터프레임으로 변환
- 중복 데이터 필터링 로직 필수 (엑셀 + API 중복 수집 방지)

### 2단계: 지능형 분개 (AI 기장)
- LLM이 거래 적요를 분석하여 복식부기 분개 생성
- 예: "스타벅스 5,500원" → (차) 복리후생비 5,000 + 부가세대급금 500 / (대) 미지급금 5,500
- 사용자 과거 거래 패턴을 RAG로 학습하여 맞춤형 기장
- **확신도 70% 미만 항목은 사용자에게 확인 요청 UI 표시**

### 3단계: 세무 검토
- RAG 시스템으로 최신 세법 PDF 기반 추론
- 매입세액 공제/불공제 판정
- 홈택스 전자세금계산서/카드 승인 내역과 교차 검증

### 4단계: 결과물 생성
- 합계잔액시산표, 재무상태표(대차대조표), 손익계산서
- 부가세 전자신고 파일 (.er_dat) — 국세청 전산매체 레이아웃 규격 준수
- 법인세 세무조정 계산서 (접대비 한도, 기부금, 업무용 승용차 등)

## 핵심 설계 원칙

### 룰 엔진 + AI 하이브리드 구조
명확한 세법은 코드로 고정하고, 애매한 판단만 AI에게 맡긴다.

| 구분 | 처리 방식 | 예시 |
|------|-----------|------|
| **Hard Rule** (코드) | If-else | 부가세율 10%, 접대비 한도액, 신고 기한 |
| **Soft Rule** (AI) | LLM 추론 | 적요 → 복리후생비 vs 접대비 분류 |
| **Cross-check** (검증) | 자동 검증 | AI 분류 결과가 세법상 금지 항목인지 재확인 |

### 필수 검증 로직
- **대차평균의 원리:** 모든 분개에서 차변 합계 = 대변 합계 자동 검사
- **기초잔액-기말잔액 정합성** 자동 감시
- 세율/한도 같은 민감한 값은 설정 파일(Config)로 분리 관리

### 사용자 최종 확인 (Human-in-the-loop)
AI 처리 결과를 사용자가 반드시 검토(Confirm)하고 수정할 수 있는 UI를 제공한다. AI는 보조 역할이며, 최종 신고 책임은 납세자 본인에게 있다.

## 세법 지식 베이스 (RAG 시스템)

- 관리자가 국세청 PDF(부가세/법인세 신고 가이드 등)를 업로드
- PDF 텍스트 변환 → 청크 분할 → Supabase pgvector 저장
- 연도별 세법 버전 관리 (2025년용, 2026년용 등 구분 적용)
- AI 답변 시 출처 표기 필수 (예: "가이드 45페이지에 근거")

## 외부 API 연동

### 공공데이터포털 (data.go.kr)
- 사업자등록정보 진위확인 및 상태조회 (국세청) — 거래처 휴/폐업 확인
- 법인기업 재무정보 (금융위원회)
- 지방세 납부 확인 (행정안전부)

### 민간 API (핵심 데이터용)
공공 API로는 세금계산서 내역 조회, 신고서 전송이 불가하므로 민간 API를 사용한다.
- **CODEF (코드에프):** 홈택스, 은행, 카드사 데이터 표준 API
- **Popbill (팝빌):** 전자세금계산서 발행 및 국세청 전송
- **Apick (에이픽):** 사업자 상세 정보 및 세무 자료 수집

## 알림 시스템

- 세무 일정 자동 알림: 부가세(개인 1/7월, 법인 1/4/7/10월), 소득세, 법인세
- 알림 채널: 이메일(Gmail/SendGrid), 카카오톡 알림톡(Popbill/비즈뿌리오 API)
- 알림 시점: D-30, D-7, D-1 (사용자 설정 가능)
- 자료 업로드 시 회계 처리 결과 이메일 리포트 자동 발송 (처리 요약, 재무 현황, 예상 세액, 특이 사항 포함)

## 반응형 UI 규칙

- 데스크탑: 3~4열 카드 + 좌측 사이드바
- 모바일: 1열 수직 + 햄버거 메뉴 + 회계 테이블은 핵심 정보만 노출
- 비정형 증빙(수기 영수증 등) OCR 실패 대비 수동 입력 UI 반드시 포함

## 보안 요구사항

- 데이터 저장: AES-256 암호화, 전송: TLS
- MFA 인증 (비밀번호 + 휴대폰/생체)
- RBAC 기반 접근 제어
- Audit Trail: AI 분류 근거, 사용자 확인 이력 전체 로그 기록
- 면책 조항 UI 표시 필수

## 개발 순서 (MVP 전략)

초기 타겟: 개인사업자 부가세 간편장부로 범위를 좁혀서 시작한다.

1. 데이터 전처리 엔진 (은행/카드사 엑셀 → 통합 데이터프레임)
2. AI 분개 에이전트 (적요 분석 → 계정과목 + 부가세 공제 T/F 판정)
3. 결산 및 리포트 엔진 (시산표 → 재무상태표/손익계산서)
4. 전자신고 생성기 (부가세 데이터 → 국세청 .er_dat 레이아웃 변환)

## 테스트 원칙

- 다양한 세무 케이스(면세 거래, 영세율, 불공제 매입 등) 샘플 데이터로 테스트
- 기존 세무 프로그램(더존, 세무사랑 등)의 결과값과 비교 검증
- 대차평균 일치 여부 자동 테스트
